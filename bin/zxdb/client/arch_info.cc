// Copyright 2018 The Fuchsia Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

#include "garnet/bin/zxdb/client/arch_info.h"

#include "garnet/public/lib/fxl/logging.h"
#include "llvm/MC/MCAsmInfo.h"
#include "llvm/MC/MCInst.h"
#include "llvm/MC/MCInstPrinter.h"
#include "llvm/MC/MCInstrInfo.h"
#include "llvm/MC/MCSubtargetInfo.h"
#include "llvm/Support/TargetRegistry.h"

// In the LLVM build the calls to this seem to be generated by the build
// automatically (e.g. when the corresponding library is loaded). Since we
// don't have that, the static registration functions need to be called
// manually.
extern "C" void LLVMInitializeAArch64TargetInfo();
extern "C" void LLVMInitializeAArch64TargetMC();
extern "C" void LLVMInitializeAArch64Disassembler();
extern "C" void LLVMInitializeX86TargetInfo();
extern "C" void LLVMInitializeX86TargetMC();
extern "C" void LLVMInitializeX86Disassembler();

namespace zxdb {

namespace {

void InitializeX64() {
  static bool initialized = false;
  if (initialized)
    return;

  LLVMInitializeX86TargetInfo();
  LLVMInitializeX86TargetMC();
  LLVMInitializeX86Disassembler();

  initialized = true;
}

void InitializeARM64() {
  static bool initialized = false;
  if (initialized)
    return;

  LLVMInitializeAArch64TargetInfo();
  LLVMInitializeAArch64TargetMC();
  LLVMInitializeAArch64Disassembler();

  initialized = true;
}

}  // namespace

ArchInfo::ArchInfo() = default;
ArchInfo::~ArchInfo() = default;

Err ArchInfo::Init(debug_ipc::Arch arch) {
  switch (arch) {
    case debug_ipc::Arch::kX64:
      InitializeX64();
      max_instr_len_ = 15;
      instr_align_ = 1;
      triple_name_ = "x86_64";
      processor_name_ = "x86-64";
      break;
    case debug_ipc::Arch::kArm64:
      InitializeARM64();
      max_instr_len_ = 4;
      instr_align_ = 4;
      triple_name_ = "aarch64";
      processor_name_ = "generic";
      break;
    default:
      FXL_NOTREACHED();
      break;
  }

  triple_ = std::make_unique<llvm::Triple>(triple_name_);

  std::string err_msg;
  target_ = llvm::TargetRegistry::lookupTarget(triple_name_, err_msg);
  if (!target_)
    return Err("Error initializing LLVM: " + err_msg);

  instr_info_.reset(target_->createMCInstrInfo());
  register_info_.reset(target_->createMCRegInfo(triple_name_));
  subtarget_info_.reset(
      target_->createMCSubtargetInfo(triple_name_, processor_name_, ""));
  asm_info_.reset(target_->createMCAsmInfo(*register_info_, triple_name_));

  if (!instr_info_ || !register_info_ || !subtarget_info_ || !asm_info_)
    return Err("Error initializing LLVM.");

  return Err();
}

}  // namespace zxdb
